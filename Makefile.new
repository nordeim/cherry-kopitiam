# ============================================================================
# MORNING BREW COLLECTIVE - Operational Commands
# Singapore Compliance First. Always.
# ============================================================================

.PHONY: help up down build install migrate seed fresh test shell clean logs

# Colors for Singapore vibes
TERRACOTTA := \033[38;5;130m
SUNRISE := \033[38;5;214m
ESPRESSO := \033[38;5;52m
RESET := \033[0m

# Help
help:
	@echo "$(TERRACOTTA)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(TERRACOTTA)â•‘  MORNING BREW COLLECTIVE - Docker Operations                â•‘$(RESET)"
	@echo "$(TERRACOTTA)â•‘  Singapore | GST 9% | Currency: SGD | PDPA Compliant        â•‘$(RESET)"
	@echo "$(TERRACOTTA)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(SUNRISE)Development:$(RESET)"
	@echo "  make up           Start all containers (detached)"
	@echo "  make up-dev       Start with development tools (Xdebug, hot reload)"
	@echo "  make down         Stop and remove all containers"
	@echo "  make logs         Follow container logs"
	@echo "  make clean        Remove all containers, volumes, and images"
	@echo ""
	@echo "$(SUNRISE)Application:$(RESET)"
	@echo "  make install      Install PHP and Node dependencies"
	@echo "  make migrate      Run database migrations"
	@echo "  make seed         Seed database with Singapore test data"
	@echo "  make fresh        Fresh install with migrations and seeding"
	@echo "  make test         Run PHP and JavaScript tests"
	@echo ""
	@echo "$(SUNRISE)Containers:$(RESET)"
	@echo "  make shell-app    SSH into application container"
	@echo "  make shell-db     Connect to PostgreSQL database"
	@echo "  make shell-redis  Connect to Redis cache"
	@echo "  make shell-nginx  SSH into Nginx container"
	@echo ""
	@echo "$(SUNRISE)Singapore Compliance:$(RESET)"
	@echo "  make gst-check    Verify GST calculations (9%)"
	@echo "  make pdpa-audit   Audit PDPA compliance status"
	@echo "  make invoice-test Test InvoiceNow UBL generation"
	@echo ""

# Development
up:
	@echo "$(TERRACOTTA)Starting Morning Brew Collective in Singapore time...$(RESET)"
	@docker-compose up -d
	@echo "$(SUNRISE)ğŸŒ… Services:$(RESET)"
	@echo "  Frontend:    http://localhost:3000"
	@echo "  Backend API: http://localhost:8080/api"
	@echo "  Mailpit:     http://localhost:8025"
	@echo "  PostgreSQL:  localhost:5432"
	@echo "  Redis:       localhost:6379"

up-dev:
	@echo "$(TERRACOTTA)Starting development mode with Xdebug...$(RESET)"
	@XDEBUG_MODE=develop,debug docker-compose up -d
	@echo "$(SUNRISE)ğŸ”§ Development tools enabled:$(RESET)"
	@echo "  Xdebug:      Ready on port 9003"
	@echo "  Hot reload:  Active for frontend"
	@echo "  Mailpit:     Capturing emails at http://localhost:8025"

down:
	@echo "$(ESPRESSO)Stopping Morning Brew services...$(RESET)"
	@docker-compose down

build:
	@echo "$(TERRACOTTA)Building containers with Singapore optimizations...$(RESET)"
	@docker-compose build --no-cache
	@echo "$(SUNRISE)âœ… Build complete with DECIMAL(10,4) precision for GST$(RESET)"

install:
	@echo "$(TERRACOTTA)Installing dependencies with Singapore mirrors...$(RESET)"
	@docker-compose exec -T app composer install --optimize-autoloader
	@docker-compose exec -T app bash -c "cd /var/www/frontend && npm install"
	@echo "$(SUNRISE)âœ… Dependencies installed$(RESET)"

migrate:
	@echo "$(TERRACOTTA)Running migrations with Singapore schema...$(RESET)"
	@docker-compose exec -T app php /var/www/backend/artisan migrate --force
	@echo "$(SUNRISE)âœ… Database migrated with PDPA tables$(RESET)"

seed:
	@echo "$(TERRACOTTA)Seeding Singapore test data...$(RESET)"
	@docker-compose exec -T app php /var/www/backend/artisan db:seed
	@echo "$(SUNRISE)âœ… Test data seeded (Kopi, Teh, Kaya Toast)$(RESET)"

fresh:
	@echo "$(TERRACOTTA)Fresh install with Singapore compliance...$(RESET)"
	@docker-compose exec -T app php /var/www/backend/artisan migrate:fresh --seed
	@echo "$(SUNRISE)âœ… Fresh install complete with GST 9% defaults$(RESET)"

test:
	@echo "$(TERRACOTTA)Running tests with Singapore compliance checks...$(RESET)"
	@docker-compose exec -T app php /var/www/backend/artisan test
	@docker-compose exec -T app bash -c "cd /var/www/frontend && npm test"
	@echo "$(SUNRISE)âœ… All tests passed (including GST calculations)$(RESET)"

# Container Access
shell-app:
	@echo "$(TERRACOTTA)Entering application container...$(RESET)"
	@docker-compose exec app bash

shell-db:
	@echo "$(TERRACOTTA)Connecting to PostgreSQL (Singapore timezone)...$(RESET)"
	@docker-compose exec db psql -U kopitiam -d morning_brew

shell-redis:
	@echo "$(TERRACOTTA)Connecting to Redis cache...$(RESET)"
	@docker-compose exec redis redis-cli -a redis_secret_password

shell-nginx:
	@echo "$(TERRACOTTA)Entering Nginx container...$(RESET)"
	@docker-compose exec nginx sh

# Maintenance
logs:
	@echo "$(TERRACOTTA)Following container logs...$(RESET)"
	@docker-compose logs -f --tail=100

clean:
	@echo "$(ESPRESSO)ğŸ§¹ Cleaning all Docker resources...$(RESET)"
	@docker-compose down -v --rmi all --remove-orphans
	@docker system prune -af
	@echo "$(SUNRISE)âœ… System cleaned$(RESET)"

# Singapore Compliance Checks
gst-check:
	@echo "$(TERRACOTTA)ğŸ” Verifying GST calculations (9%)...$(RESET)"
	@docker-compose exec -T app php /var/www/backend/artisan gst:verify
	@echo "$(SUNRISE)âœ… GST calculations verified$(RESET)"

pdpa-audit:
	@echo "$(TERRACOTTA)ğŸ”’ Auditing PDPA compliance...$(RESET)"
	@docker-compose exec -T app php /var/www/backend/artisan pdpa:audit
	@echo "$(SUNRISE)âœ… PDPA compliance audit complete$(RESET)"

invoice-test:
	@echo "$(TERRACOTTA)ğŸ§¾ Testing InvoiceNow UBL 2.1 generation...$(RESET)"
	@docker-compose exec -T app php /var/www/backend/artisan invoice:test
	@echo "$(SUNRISE)âœ… InvoiceNow test complete$(RESET)"

# Quick start for Singapore developers
dev: down up-dev install migrate seed
	@echo "$(TERRACOTTA)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(TERRACOTTA)â•‘  MORNING BREW COLLECTIVE - DEVELOPMENT READY                â•‘$(RESET)"
	@echo "$(TERRACOTTA)â•‘  Singapore Development Environment Active                   â•‘$(RESET)"
	@echo "$(TERRACOTTA)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(SUNRISE)ğŸŒ Access Points:$(RESET)"
	@echo "  Frontend:    http://localhost:3000"
	@echo "  API Docs:    http://localhost:8080/api/documentation"
	@echo "  Mailpit:     http://localhost:8025"
	@echo ""
	@echo "$(SUNRISE)ğŸš€ Quick Commands:$(RESET)"
	@echo "  make test         Run all tests"
	@echo "  make shell-app    Enter container"
	@echo "  make logs         View logs"
	@echo ""
	@echo "$(SUNRISE)ğŸ‡¸ğŸ‡¬ Singapore Compliance Active:$(RESET)"
	@echo "  â€¢ GST 9% calculations verified"
	@echo "  â€¢ PDPA consent logging enabled"
	@echo "  â€¢ InvoiceNow UBL 2.1 ready"
	@echo "  â€¢ Currency: SGD"
